
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Deploying Discourse with Capistrano - davidcel.is</title>
	<meta name="author" content="David Celis">

	
	<meta name="description" content="With the recent release of Discourse, an excellent piece of forum software by Jeff Atwood, Robin Ward and Sam Saffron, I was eager to get an &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="davidcel.is" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">davidcel.is</a></h1>
<nav id="main-nav"><ul class="main">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">Meet David</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">Meet David</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:davidcelis.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		<a class="facebook" href="http://www.facebook.com/davidcelis" title="Facebook">Facebook</a>
		
		
		
		<a class="twitter" href="http://twitter.com/davidcelis" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/davidcelis" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:davidcelis.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Deploying Discourse With Capistrano</h2>
	<div class="entry-content"><p>With the recent release of <a href="http://www.discourse.org/">Discourse</a>, an excellent piece of forum software by <a href="http://codinghorror.com/">Jeff Atwood</a>, <a href="http://eviltrout.com/">Robin Ward</a> and <a href="http://samsaffron.com/">Sam Saffron</a>, I was eager to get an installation up and running myself. With a simple layout it seemed like just what I needed as <a href="https://forums.goodbre.ws/">support and discussion forums for goodbre.ws</a>. Discourse is still considered to be squarely in the beta phase, so I had a hard time finding any guides or tutorials that fit my needs for deploying Discourse to a VPS. I did find a <a href="https://github.com/baus/install-discourse">nice tutorial</a> by Christopher Baus, but I wanted to get a setup using Capistrano rather than <code>init.d</code> because that feels much more Railsy to me. Read on for how I got a Digital Ocean droplet running Discourse on thin with zero-downtime deployments.</p>

<!--more-->


<h2>Set up your VPS</h2>

<p><em>If you&#8217;re a Chef wiz and already have some recipes for Discourse, you can skip ahead to the section on setting up Discourse. Chef is still on my learning TODO list, so I provisioned a server from scratch.</em></p>

<p>I started with a <a href="http://www.digitalocean.com/">Digital Ocean</a> droplet running the latest release of Ubuntu 13.04, but presumably any VPS running a recent release (12.04 or 12.10) of Ubuntu should do. Make sure your server has at least 1GB of RAM; you&#8217;ll need it to compile all of Discourse&#8217;s assets. I chose the 1GB / 1CPU plan, and it&#8217;s served me well thus far.</p>

<h3>Secure your server</h3>

<p><a href="http://www.linode.com/">Linode</a> already has an <a href="http://library.linode.com/securing-your-server">excellent guide</a> on hiding your server from prying eyes, so I suggest following it to the T. I don&#8217;t want to reinvent the wheel here, so this is what I followed exactly. I set my username to <code>goodbrews</code> for deploying anything related to that site.</p>

<h3>Change your server&#8217;s hostname</h3>

<p>Depending on what characters you included in your droplet&#8217;s name, DigitalOcean may not set the hostname correctly. To change my server&#8217;s hostname, I did the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo </span>forums.goodbre.ws | sudo tee /etc/hostname
</span></code></pre></td></tr></table></div></figure>


<p>Because I deployed my installation to <code>forums.goodbre.ws</code>, I changed the first line of my <code>/etc/hosts/</code> file to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>127.0.0.1 localhost forums.goodbre.ws</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Create a swapfile</h3>

<p>If you&#8217;re running on a VPS service that automatically provisions a swap (such as Linode), you can skip this. On Digital Ocean, however, you&#8217;ll need to do this yourself. 1GB of RAM was enough for my first deployment but, when I tried to run a second, I wasn&#8217;t able to allocate enough memory to compile assets. Creating a swap, however, has fixed this issue for me. Let&#8217;s create a 512MB swapfile:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/swapfile <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>512k
</span><span class='line'>sudo mkswap /swapfile
</span><span class='line'>sudo swapon /swapfile
</span></code></pre></td></tr></table></div></figure>


<p>Then, you&#8217;ll need to edit <code>/etc/fstab</code> and paste in the following line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/swapfile       none    swap    sw      0       0</span></code></pre></td></tr></table></div></figure>


<p>Finally, prevent your swapfile from being readable:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo chown root:root /swapfile
</span><span class='line'>sudo chmod 0600 /swapfile
</span></code></pre></td></tr></table></div></figure>




<br />


<h3>Install Ruby 2.0.0-p0 and bundler</h3>

<p>SSH into your VPS as your deployment user and install the necessary dependencies to build Ruby on Ubuntu:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install build-essential openssl libreadline6 libreadline6-dev <span class="se">\</span>
</span><span class='line'>             curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev <span class="se">\</span>
</span><span class='line'>             sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev libgdbm-dev <span class="se">\</span>
</span><span class='line'>             ncurses-dev automake libtool bison subversion pkg-config libffi-dev
</span></code></pre></td></tr></table></div></figure>


<p>Now, I personally enjoy using rbenv and ruby-build, so this tutorial will follow installation prodecures around those tools. Feel free to use RVM, chruby, or some other Ruby version manager if you wish.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Install rbenv</span>
</span><span class='line'>git clone git://github.com/sstephenson/rbenv.git ~/.rbenv
</span><span class='line'>
</span><span class='line'><span class="c"># Setup rbenv initialization</span>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;export PATH=&quot;$HOME/.rbenv/bin:$PATH&quot;&#39;</span> &gt;&gt; ~/.bash_profile
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;eval &quot;$(rbenv init -)&quot;&#39;</span> &gt;&gt; ~/.bash_profile
</span><span class='line'>
</span><span class='line'><span class="c"># Restart your shell to use rbenv</span>
</span><span class='line'><span class="nb">exec</span> <span class="nv">$SHELL</span> -l
</span><span class='line'>
</span><span class='line'><span class="c"># Install ruby-build</span>
</span><span class='line'>git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build
</span><span class='line'>
</span><span class='line'><span class="c"># Install Ruby 2.0.0-p0 and set it as your user&#39;s default</span>
</span><span class='line'>rbenv install 2.0.0-p0; rbenv global 2.0.0-p0
</span></code></pre></td></tr></table></div></figure>


<p><em>NOTE: the installation guide for <code>rbenv</code> mentions using <code>~/.profile</code> instead of <code>~/.bash_profile</code>, but I found the latter to work for me. You can try either if you have issues.</em></p>

<p>Finally, you&#8217;ll need bundler.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install bundler --no-rdoc --no-ri
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Install nginx</h3>

<p>I prefer to run my Rails apps under nginx. Plus, Discourse comes with a sample configuration file that requires little tweaking. No brainer!</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install nginx
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Install PostgreSQL, Redis, and other required libraries</h3>

<p>Discourse requires <a href="http://www.postgresql.org">PostgreSQL</a> and <a href="http://redis.io/">Redis</a> to run, so let&#8217;s install those as well:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install postgresql-9.1 postgresql-contrib-9.1 redis-server <span class="se">\</span>
</span><span class='line'>                     libxml2-dev libxslt-dev libpq-dev make g++
</span></code></pre></td></tr></table></div></figure>


<p>Note that postgresql-contrib-9.1 will install the hstore extension for PostgreSQL, which Discourse requires. You&#8217;ll need to create a postgres role and Discourse&#8217;s production database:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Create your postgres role (I named mine goodbrews, go figure)</span>
</span><span class='line'>sudo -u postgres createuser goodbrews -s -P
</span><span class='line'>
</span><span class='line'><span class="c"># Create discourse&#39;s production database (I named mine discourse_production)</span>
</span><span class='line'>createdb -U goodbrews discourse_production
</span></code></pre></td></tr></table></div></figure>


<p>And now your VPS should be set up and ready to run Discourse! That means it&#8217;s time to&#8230;</p>

<h2>Set up Discourse</h2>

<p>Because you&#8217;ll need to configure it yourself, Discourse is a prime candidate for <a href="https://github.com/discourse/discourse/fork">forking</a>. If you don&#8217;t have Ruby installed on your own computer, yet, I recommend installing rbenv locally. The same steps above will work (or follow rbenv&#8217;s <a href="https://github.com/sstephenson/rbenv">installation guide</a>), so make sure you have Ruby 2.0.0-p0 installed.</p>

<p>Then, clone your fork locally (on your own computer).</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git@github.com:&lt;your_github_username&gt;/discourse.git
</span><span class='line'><span class="nb">cd </span>discourse
</span><span class='line'>gem install bundler
</span><span class='line'>bundle install
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Edit the Discourse configuration files</h3>

<p>Copy the sample configuration files&#8230;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp config/database.yml.sample config/database.yml
</span><span class='line'>cp config/nginx.sample.conf config/nginx.conf
</span><span class='line'>cp config/redis.yml.sample config/redis.yml
</span><span class='line'>cp config/environments/production.sample.rb config/environments/production.rb
</span></code></pre></td></tr></table></div></figure>


<p>&#8230; and edit them with your own information. <code>database.yml</code> should, of course, be edited to use the postgres role that you configured earlier (I also changed the name of the production database to <code>discourse_production</code> as I mentioned earlier).</p>

<p><code>redis.yml</code> is unlikely to change if you&#8217;ve followed this guide and are running it on the same server.</p>

<p><code>production.rb</code> is where you&#8217;ll want to configure how your Discourse installation&#8217;s email gets sent out. Personally, I use <a href="http://mandrillapp.com/">Mandrill</a> and configured my app to hit their API.</p>

<p><code>nginx.conf</code> is trickier depending on your needs, however. For instance, I set my discourse installation up to use HTTPS and provisioned SSL certificates from <a href="https://startssl.com/">StartSSL</a>. For the purposes of this guide, we&#8217;ll stick with basic HTTP. I prefer deploying my applications into the home directory of my deployment user to ensure proper ownership, so my <code>nginx.conf</code> file ended up looking like:</p>

<figure class='code'><figcaption><span>config/nginx.conf </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">upstream</span> <span class="s">discourse</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">server</span> <span class="s">unix:///home/goodbrews/discourse/shared/sockets/thin.0.sock</span> <span class="s">max_fails=1</span> <span class="s">fail_timeout=15s</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">server</span> <span class="s">unix:///home/goodbrews/discourse/shared/sockets/thin.1.sock</span> <span class="s">max_fails=1</span> <span class="s">fail_timeout=15s</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">server</span> <span class="s">unix:///home/goodbrews/discourse/shared/sockets/thin.2.sock</span> <span class="s">max_fails=1</span> <span class="s">fail_timeout=15s</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">server</span> <span class="s">unix:///home/goodbrews/discourse/shared/sockets/thin.3.sock</span> <span class="s">max_fails=1</span> <span class="s">fail_timeout=15s</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">server</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">gzip</span> <span class="no">on</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">gzip_min_length</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">gzip_types</span> <span class="s">application/json</span> <span class="s">text/css</span> <span class="s">application/x-javascript</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">server_name</span> <span class="s">forums.goodbre.ws</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">sendfile</span> <span class="no">on</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">root</span> <span class="s">/home/goodbrews/discourse/current/public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">location</span> <span class="p">~</span> <span class="sr">^/t\/[0-9]+\/[0-9]+\/avatar</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">expires</span> <span class="s">1d</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">add_header</span> <span class="s">Cache-Control</span> <span class="s">public</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">add_header</span> <span class="s">ETag</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">location</span> <span class="p">~</span> <span class="sr">^/assets/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">expires</span> <span class="s">1y</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">add_header</span> <span class="s">Cache-Control</span> <span class="s">public</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">add_header</span> <span class="s">ETag</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">proxy_set_header</span>  <span class="s">X-Real-IP</span>  <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">proxy_set_header</span>  <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">proxy_set_header</span>  <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">proxy_set_header</span>  <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># If the file exists as a static file serve it directly without</span>
</span><span class='line'>    <span class="c1"># running all the other rewite tests on it</span>
</span><span class='line'>    <span class="kn">if</span> <span class="s">(-f</span> <span class="nv">$request_filename</span><span class="s">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">if</span> <span class="s">(!-f</span> <span class="nv">$request_filename</span><span class="s">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">proxy_pass</span> <span class="s">http://discourse</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>max_fails=1 fail_timeout=15s</code> statements on the end of the upstream thin servers is what will help us achieve zero-downtime deployments. As we&#8217;re phasing out old thin processes with new ones, any failures on an old thin process will cause nginx to cease handing it requests. It will, instead, hand the request to an old thin process that&#8217;s either still running or one of the new thin processes that has already started.</p>

<h3>Configure thin</h3>

<p>You&#8217;ll also want a thin configuration file to make your life easier:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>thin config -C config/thin.yml --servers 4 -e production/home/goodbrews/forums/current
</span></code></pre></td></tr></table></div></figure>


<p>This will generate a file, <code>config/thin.yml</code>, which you should then go edit. Make sure to set the <code>chdir</code>, <code>log</code>, <code>pid</code>, and <code>socket</code> keys to the correct paths. My thin configuration looks like this:</p>

<figure class='code'><figcaption><span>config/thin.yml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">chdir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/goodbrews/discourse/current</span>
</span><span class='line'><span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">production</span>
</span><span class='line'><span class="l-Scalar-Plain">address</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0.0.0.0</span>
</span><span class='line'><span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3000</span>
</span><span class='line'><span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
</span><span class='line'><span class="l-Scalar-Plain">log</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/goodbrews/discourse/shared/log/thin.log</span>
</span><span class='line'><span class="l-Scalar-Plain">pid</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/goodbrews/discourse/shared/pids/thin.pid</span>
</span><span class='line'><span class="l-Scalar-Plain">socket</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/goodbrews/discourse/shared/sockets/thin.sock</span>
</span><span class='line'><span class="l-Scalar-Plain">max_conns</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1024</span>
</span><span class='line'><span class="l-Scalar-Plain">max_persistent_conns</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100</span>
</span><span class='line'><span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class='line'><span class="l-Scalar-Plain">wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
</span><span class='line'><span class="l-Scalar-Plain">servers</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
</span><span class='line'><span class="l-Scalar-Plain">daemonize</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'><span class="l-Scalar-Plain">onebyone</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<p>Make sure you add the <code>onebyone: true</code> key. This is the secret sauce that will make your Thin servers restart&#8230; You guessed it&#8230; One by one. Zero downtime!</p>

<h3>Create a secret token</h3>

<p>Discourse doesn&#8217;t ship with a secret token set, since it&#8217;s not recommended to be version controlled. Therefore, you&#8217;ll need to generate one and set it yourself:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bundle <span class="nb">exec </span>rake secret
</span></code></pre></td></tr></table></div></figure>


<p>Open up <code>config/initializers/secret_token.rb</code> and paste the generated secret somewhere (probably line 10). You can delete the rest of the file.</p>

<h3>Set up Capistrano</h3>

<p>Add the following to Discourse&#8217;s <code>Gemfile</code>:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">nil</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a <code>Capfile</code> in Discourse&#8217;s root directory:</p>

<figure class='code'><figcaption><span>Capfile </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">load</span> <span class="s1">&#39;deploy&#39;</span> <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:namespace</span><span class="p">)</span>
</span><span class='line'><span class="nb">load</span> <span class="s1">&#39;deploy/assets&#39;</span>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s1">&#39;vendor/plugins/*/recipes/*.rb&#39;</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span> <span class="nb">load</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="nb">load</span> <span class="s1">&#39;config/deploy&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create your deployment recipe file at <code>config/deploy.rb</code>. Here&#8217;s what mine looks like:</p>

<figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Require the necessary Capistrano recipes</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano-rbenv&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler/capistrano&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;sidekiq/capistrano&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Repository settings, forked to an outside copy</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s1">&#39;git@github.com:goodbrews/forums.git&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_via</span><span class="p">,</span> <span class="ss">:remote_cache</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:branch</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'><span class="n">ssh_options</span><span class="o">[</span><span class="ss">:forward_agent</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># General Settings</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_type</span><span class="p">,</span> <span class="ss">:deploy</span>
</span><span class='line'><span class="n">default_run_options</span><span class="o">[</span><span class="ss">:pty</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Server Settings</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s1">&#39;goodbrews&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:use_sudo</span><span class="p">,</span> <span class="kp">false</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_ruby_version</span><span class="p">,</span> <span class="s1">&#39;2.0.0-p0&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s1">&#39;forums.goodbre.ws&#39;</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:db</span><span class="p">,</span>  <span class="s1">&#39;forums.goodbre.ws&#39;</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:web</span><span class="p">,</span> <span class="s1">&#39;forums.goodbre.ws&#39;</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Application Settings</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;discourse&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Keep your bundle up to date!</span>
</span><span class='line'><span class="n">after</span> <span class="s2">&quot;deploy:setup&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; bundle install&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Tasks to start, stop and restart thin. This takes Discourse&#39;s</span>
</span><span class='line'>  <span class="c1"># recommendation of changing the RUBY_GC_MALLOC_LIMIT.</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Start thin servers&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; RUBY_GC_MALLOC_LIMIT=90000000 bundle exec thin -C config/thin.yml start&quot;</span><span class="p">,</span> <span class="ss">:pty</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Stop thin servers&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:stop</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; bundle exec thin -C config/thin.yml stop&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Restart thin servers&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; RUBY_GC_MALLOC_LIMIT=90000000 bundle exec thin -C config/thin.yml restart&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Sets up several shared directories for configuration and thin&#39;s sockets,</span>
</span><span class='line'>  <span class="c1"># as well as uploading your sensitive configuration files to the serer.</span>
</span><span class='line'>  <span class="c1"># The uploaded files are ones I&#39;ve removed from version control since my</span>
</span><span class='line'>  <span class="c1"># project is public. This task also symlinks the nginx configuration so, if</span>
</span><span class='line'>  <span class="c1"># you change that, re-run this task.</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:setup_config</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/initializers&quot;</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/environments&quot;</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/sockets&quot;</span>
</span><span class='line'>    <span class="n">put</span>  <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;config/database.yml&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/database.yml&quot;</span>
</span><span class='line'>    <span class="n">put</span>  <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;config/redis.yml&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/redis.yml&quot;</span>
</span><span class='line'>    <span class="n">put</span>  <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;config/environments/production.rb&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/environments/production.rb&quot;</span>
</span><span class='line'>    <span class="n">put</span>  <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;config/initializers/secret_token.rb&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/initializers/secret_token.rb&quot;</span>
</span><span class='line'>    <span class="n">sudo</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/nginx.conf /etc/nginx/sites-enabled/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Now edit the config files in </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Symlinks all of your uploaded configuration files to where they should be.</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:symlink_config</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/database.yml </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/database.yml&quot;</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/newrelic.yml </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/newrelic.yml&quot;</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/redis.yml </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/redis.yml&quot;</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/environments/production.rb </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/environments/production.rb&quot;</span>
</span><span class='line'>    <span class="n">run</span>  <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/initializers/secret_token.rb </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/initializers/secret_token.rb&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">after</span> <span class="s2">&quot;deploy:setup&quot;</span><span class="p">,</span> <span class="s2">&quot;deploy:setup_config&quot;</span>
</span><span class='line'><span class="n">after</span> <span class="s2">&quot;deploy:finalize_update&quot;</span><span class="p">,</span> <span class="s2">&quot;deploy:symlink_config&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Tasks to start/stop/restart the clockwork process.</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:clockwork</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Start clockwork&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:app</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"> bundle exec clockworkd -c </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/config/clock.rb --pid-dir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/pids --log --log-dir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/log start&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:stop</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:app</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"> bundle exec clockworkd -c </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/config/clock.rb --pid-dir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/pids --log --log-dir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/log stop&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:app</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"> bundle exec clockworkd -c </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/config/clock.rb --pid-dir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/pids --log --log-dir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/log restart&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">after</span>  <span class="s2">&quot;deploy:stop&quot;</span><span class="p">,</span>    <span class="s2">&quot;clockwork:stop&quot;</span>
</span><span class='line'><span class="n">after</span>  <span class="s2">&quot;deploy:start&quot;</span><span class="p">,</span>   <span class="s2">&quot;clockwork:start&quot;</span>
</span><span class='line'><span class="n">before</span> <span class="s2">&quot;deploy:restart&quot;</span><span class="p">,</span> <span class="s2">&quot;clockwork:restart&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Seed your database for the first time&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:seed</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; psql -d discourse_production &lt; pg_dumps/production-image.sql&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">after</span>  <span class="s1">&#39;deploy:update_code&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:migrate&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>These should be all of the necessary Capistrano recipes you need to run your first deployment. Let&#8217;s do that now!</p>

<h2>Deploy Discourse</h2>

<p>Okay, you&#8217;ve got your server set up and Discourse configured&#8230; Let&#8217;s do this!</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Set up the server&#39;s directory structure for Capistrano</span>
</span><span class='line'>cap deploy:setup
</span><span class='line'>
</span><span class='line'><span class="c"># Seed the database you created earlier</span>
</span><span class='line'>cap db:seed
</span><span class='line'>
</span><span class='line'><span class="c"># Do the first deploy! No server is running yet, so do a cold deployment</span>
</span><span class='line'>cap deploy:cold
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Discourse</h2>

<p>Congratulations! You should now have Discourse running on your VPS. Now that your forums are up and running, you&#8217;ll want to follow the <a href="https://github.com/discourse/discourse/wiki/The-Discourse-Admin-Quick-Start-Guide">Quick Start Guide</a> that the Discourse team has written up.</p>

<h2>Keeping Discourse up-to-date</h2>

<p>You&#8217;ll, of course, want to keep your copy of Discourse up-to-date with the main repository. To do so, <code>cd</code> into your local copy and set up an upstream remote:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git remote add upstream git@github.com:discourse/discourse.git
</span><span class='line'>git fetch upstream
</span><span class='line'>git merge upstream/master
</span><span class='line'>git push origin master
</span><span class='line'>cap deploy
</span></code></pre></td></tr></table></div></figure>


<p>And there you go. Whenever you want to update, just fetch upstream, merge it into master, push, and redeploy.</p>

<h3>Anything here wrong?</h3>

<p>Please let me know if the above steps didn&#8217;t work for you. It&#8217;s possible that I accidentally left a step out of my process or that the process has changed and I don&#8217;t know about it. Reply to <a href="http://meta.discourse.org/t/deploy-discourse-to-an-ubuntu-vps-using-capistrano/6353">my thread on meta.discourse.org</a> where I&#8217;ve posted this guide, or shoot me an email using the link below.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-05-02T10:42:00-07:00" pubdate data-updated="true">May 2<span>nd</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/discourse/'>discourse</a>, <a class='category' href='/blog/categories/goodbrews/'>goodbrews</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>

<section id="contact">
  Have something to say about this post? <script type="text/javascript">eval(unescape("%69%6d%73%6b%67%33%34%3d%5b%27%25%36%34%25%36%31%25%37%36%25%36%39%25%36%34%27%2c%5b%27%25%36%33%25%36%66%25%36%64%27%2c%27%25%36%34%25%36%31%25%37%36%25%36%39%25%36%34%25%36%33%25%36%35%25%36%63%25%36%39%25%37%33%27%5d%2e%72%65%76%65%72%73%65%28%29%2e%6a%6f%69%6e%28%27%2e%27%29%5d%2e%6a%6f%69%6e%28%27%40%27%29%3b%6d%65%6f%63%74%37%35%3d%27%53%68%6f%6f%74%20%6d%65%20%61%6e%20%65%6d%61%69%6c%27%3b%64%6f%63%75%6d%65%6e%74%2e%77%72%69%74%65%28%6d%65%6f%63%74%37%35%2e%6c%69%6e%6b%28%27%6d%61%69%27%2b%27%6c%74%6f%3a%27%2b%69%6d%73%6b%67%33%34%29%29%3b"));</script>; I'd love to talk!
</section>


	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    David Celis

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-28731352-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>